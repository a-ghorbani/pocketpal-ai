desc "Bump version for both Android and iOS"
lane :bump_version do |options|
  version_type = options[:version_type] || "patch"
  root_dir = File.expand_path('..', Dir.pwd)
  
  # Common paths
  package_json_path = File.join(root_dir, 'package.json')
  version_file_path = File.join(root_dir, '.version')

  # Bump version in package.json
  Dir.chdir(root_dir) do
    sh("yarn version --#{version_type} --no-git-tag-version")
  end
  
  new_version = JSON.parse(File.read(package_json_path))['version']
  sh("echo #{new_version} > #{version_file_path}")

  # Generate common build number based on timestamp
  build_number = Time.now.strftime("%Y%m%d%H%M")

  # Bump Android version
  gradle_file = File.join(root_dir, "android/app/build.gradle")
  android_set_version_code(
    gradle_file: gradle_file,
    version_code: build_number
  )
  
  android_set_version_name(
    gradle_file: gradle_file,
    version_name: new_version
  )

  # Bump iOS version
  ios_dir = File.join(root_dir, 'ios')
  Dir.chdir(ios_dir) do
    increment_version_number_in_xcodeproj(
      version_number: new_version,
      xcodeproj: File.join(ios_dir, "PocketPal.xcodeproj")
    )
    increment_build_number_in_xcodeproj(
      build_number: build_number,
      xcodeproj: File.join(ios_dir, "PocketPal.xcodeproj")
    )
  end

  UI.message("Bumped Android and iOS versions to #{new_version}")
end
