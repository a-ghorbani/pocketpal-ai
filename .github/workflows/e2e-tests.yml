name: E2E Tests (AWS Device Farm)

on:
  # Manual trigger with platform selection
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to test'
        required: true
        default: 'android'
        type: choice
        options:
          - android
          - ios
          - both

  # Optionally run on main branch pushes
  # push:
  #   branches: [main]

env:
  NODE_VERSION: '22'
  JAVA_VERSION: '17'

jobs:
  build-android:
    if: ${{ github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Create dummy google-services.json for CI
        run: |
          cat > android/app/google-services.json << 'EOL'
          {
            "project_info": {
              "project_number": "000000000000",
              "project_id": "dummy-project-for-ci",
              "storage_bucket": "dummy-project-for-ci.appspot.com"
            },
            "client": [{
              "client_info": {
                "mobilesdk_app_id": "1:000000000000:android:0000000000000000",
                "android_client_info": {
                  "package_name": "com.pocketpalai"
                }
              },
              "api_key": [{
                "current_key": "dummy-api-key-for-ci-builds"
              }]
            }]
          }
          EOL

      - name: Create dummy .env file for CI
        run: |
          cat > .env << 'EOL'
          FIREBASE_FUNCTIONS_URL=https://dummy-firebase-url.com
          SUPABASE_URL=https://dummy-supabase-url.supabase.co
          SUPABASE_ANON_KEY=dummy-anon-key-for-ci-builds
          PALSHUB_API_BASE_URL=https://dummy-palshub-api.com
          APP_URL=pocketpal://app
          ENABLE_PALSHUB_INTEGRATION=true
          ENABLE_AUTHENTICATION=true
          ENABLE_OFFLINE_MODE=true
          GOOGLE_IOS_CLIENT_ID=dummy-ios-client-id.apps.googleusercontent.com
          GOOGLE_WEB_CLIENT_ID=dummy-web-client-id.apps.googleusercontent.com
          EOL

      - name: Create dummy release keystore for CI
        working-directory: android/app
        run: |
          keytool -genkeypair -v \
            -storetype PKCS12 \
            -keystore pocketpal-release-key.keystore \
            -alias pocketpal_key_alias \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass dummy-ci-password \
            -keypass dummy-ci-password \
            -dname "CN=CI Build, OU=CI, O=PocketPal, L=CI, S=CI, C=US"

      - name: Build Android Release APK
        env:
          APP_RELEASE_STORE_PASSWORD: dummy-ci-password
          APP_RELEASE_KEY_PASSWORD: dummy-ci-password
        run: |
          cd android
          ./gradlew assembleRelease

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: android/app/build/outputs/apk/release/app-release.apk

  build-ios:
    if: ${{ github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' }}
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Create Env.xcconfig
        run: |
          cat > ios/Config/Env.xcconfig << 'EOL'
          // This file contains environment-specific build settings.

          GOOGLE_WEB_CLIENT_ID = dummy-web-client-id.apps.googleusercontent.com
          REVERSED_GOOGLE_IOS_CLIENT_ID = com.googleusercontent.apps.dummy-ios-client-id

          EOL

      - name: Create dummy .env file for CI
        run: |
          cat > .env << 'EOL'
          FIREBASE_FUNCTIONS_URL=https://dummy-firebase-url.com
          SUPABASE_URL=https://dummy-supabase-url.supabase.co
          SUPABASE_ANON_KEY=dummy-anon-key-for-ci-builds
          PALSHUB_API_BASE_URL=https://dummy-palshub-api.com
          APP_URL=pocketpal://app
          ENABLE_PALSHUB_INTEGRATION=true
          ENABLE_AUTHENTICATION=true
          ENABLE_OFFLINE_MODE=true
          GOOGLE_IOS_CLIENT_ID=dummy-ios-client-id.apps.googleusercontent.com
          GOOGLE_WEB_CLIENT_ID=dummy-web-client-id.apps.googleusercontent.com
          EOL

      - name: Create dummy GoogleService-Info.plist for CI
        run: |
          cat > ios/GoogleService-Info.plist << 'EOL'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CLIENT_ID</key>
            <string>dummy-client-id.apps.googleusercontent.com</string>
            <key>REVERSED_CLIENT_ID</key>
            <string>com.googleusercontent.apps.dummy-client-id</string>
            <key>API_KEY</key>
            <string>dummy-api-key-for-ci-builds</string>
            <key>GCM_SENDER_ID</key>
            <string>000000000000</string>
            <key>PLIST_VERSION</key>
            <string>1</string>
            <key>BUNDLE_ID</key>
            <string>ai.pocketpal</string>
            <key>PROJECT_ID</key>
            <string>dummy-project-for-ci</string>
            <key>STORAGE_BUCKET</key>
            <string>dummy-project-for-ci.appspot.com</string>
            <key>IS_ADS_ENABLED</key>
            <false/>
            <key>IS_ANALYTICS_ENABLED</key>
            <false/>
            <key>IS_APPINVITE_ENABLED</key>
            <false/>
            <key>IS_GCM_ENABLED</key>
            <true/>
            <key>IS_SIGNIN_ENABLED</key>
            <true/>
            <key>GOOGLE_APP_ID</key>
            <string>1:000000000000:ios:0000000000000000</string>
          </dict>
          </plist>
          EOL

      - name: Install CocoaPods
        run: |
          cd ios
          pod install

      - name: Build iOS Release IPA
        run: |
          cd ios
          xcodebuild -workspace PocketPal.xcworkspace \
            -scheme PocketPal \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/PocketPal.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

          # Create IPA from archive
          mkdir -p build/Payload
          cp -r build/PocketPal.xcarchive/Products/Applications/PocketPal.app build/Payload/
          cd build
          zip -r PocketPal.ipa Payload

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ios/build/PocketPal.ipa

  test-android:
    needs: build-android
    if: ${{ github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: ./app

      - name: Install E2E dependencies
        run: |
          cd e2e
          yarn install --frozen-lockfile

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Run E2E tests on AWS Device Farm
        env:
          AWS_DEVICE_FARM_PROJECT_ARN: ${{ vars.AWS_DEVICE_FARM_PROJECT_ARN }}
          AWS_DEVICE_POOL_ARN_ANDROID: ${{ vars.AWS_DEVICE_POOL_ARN_ANDROID }}
        run: |
          cd e2e
          yarn test:aws --platform android --app ../app/app-release.apk

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-test-artifacts
          path: e2e/device-farm-artifacts/
          retention-days: 30

      - name: Publish Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Android E2E Test Results
          path: e2e/device-farm-artifacts/**/junit*.xml
          reporter: java-junit
          fail-on-error: false

  test-ios:
    needs: build-ios
    if: ${{ github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: ./app

      - name: Install E2E dependencies
        run: |
          cd e2e
          yarn install --frozen-lockfile

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Run E2E tests on AWS Device Farm
        env:
          AWS_DEVICE_FARM_PROJECT_ARN: ${{ vars.AWS_DEVICE_FARM_PROJECT_ARN }}
          AWS_DEVICE_POOL_ARN_IOS: ${{ vars.AWS_DEVICE_POOL_ARN_IOS }}
        run: |
          cd e2e
          yarn test:aws --platform ios --app ../app/PocketPal.ipa

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-test-artifacts
          path: e2e/device-farm-artifacts/
          retention-days: 30

      - name: Publish Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: iOS E2E Test Results
          path: e2e/device-farm-artifacts/**/junit*.xml
          reporter: java-junit
          fail-on-error: false
