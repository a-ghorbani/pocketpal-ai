name: Release Workflow (Hacker Route)

on:
  workflow_dispatch:

jobs:
  build_ios:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies (Yarn Strategy)
        run: |
          corepack enable
          yarn install --network-timeout 1000000
          cd ios && pod install && cd ..

      - name: Fix Node Path for Xcode
        run: |
          sudo ln -s $(which node) /usr/local/bin/node || true
          sudo ln -s $(which yarn) /usr/local/bin/yarn || true

      - name: Create missing config files (Env & Firebase)
        run: |
          # 1. Env.xcconfigã®ãƒ€ãƒŸãƒ¼éŒ¬æˆ
          mkdir -p ios/Config
          touch ios/Config/Env.xcconfig
          echo "// Dummy config for CI build" > ios/Config/Env.xcconfig
          
          # 2. GoogleService-Info.plistã®ã€å®Œå…¨ç‰ˆã€‘ãƒ€ãƒŸãƒ¼éŒ¬æˆ
          # ã“ã“ã§ä½œæˆã—ã¦ãŠãã€å¾Œã®ã€ŒExport IPAã€ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚¢ãƒ—ãƒªå†…ã«ç›´æ¥ã­ã˜è¾¼ã¿ã¾ã™
          cat << 'EOF' > GoogleService-Info.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CLIENT_ID</key><string>dummy.apps.googleusercontent.com</string>
            <key>REVERSED_CLIENT_ID</key><string>com.googleusercontent.apps.dummy</string>
            <key>API_KEY</key><string>dummy-api-key</string>
            <key>GCM_SENDER_ID</key><string>123456789</string>
            <key>PLIST_VERSION</key><string>1</string>
            <key>BUNDLE_ID</key><string>ai.pocketpal</string>
            <key>PROJECT_ID</key><string>dummy-project</string>
            <key>IS_ADS_ENABLED</key><false/>
            <key>IS_ANALYTICS_ENABLED</key><false/>
            <key>IS_APPINVITE_ENABLED</key><true/>
            <key>IS_GCM_ENABLED</key><true/>
            <key>IS_SIGNIN_ENABLED</key><true/>
            <key>GOOGLE_APP_ID</key><string>1:123456789:ios:dummy</string>
          </dict>
          </plist>
          EOF

      - name: Enable iTunes File Sharing (Sandbox Breakthrough)
        run: |
          # Info.plistã®ç‰¹å®š
          PLIST_PATH=$(find ios -maxdepth 2 -name "Info.plist" | grep -v "Tests" | head -n 1)
          echo "Target Plist: $PLIST_PATH"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ—ãƒªã¸ã®ãƒ•ã‚©ãƒ«ãƒ€å…¬é–‹ã‚’æœ‰åŠ¹åŒ–
          /usr/libexec/PlistBuddy -c "Add :UIFileSharingEnabled bool true" "$PLIST_PATH" || /usr/libexec/PlistBuddy -c "Set :UIFileSharingEnabled bool true" "$PLIST_PATH"
          
          # ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é–‹ãæ¨©é™ã‚’ä»˜ä¸
          /usr/libexec/PlistBuddy -c "Add :LSSupportsOpeningDocumentsInPlace bool true" "$PLIST_PATH" || /usr/libexec/PlistBuddy -c "Set :LSSupportsOpeningDocumentsInPlace bool true" "$PLIST_PATH"
          
          echo "âœ… Info.plist modified successfully for local file sharing!"

      - name: Build iOS App (Targeting Main App)
        run: |
          WORKSPACE_PATH=$(find ios -name "*.xcworkspace" | head -n 1)
          
          xcodebuild build \
            -workspace "$WORKSPACE_PATH" \
            -scheme PocketPal \
            -configuration Release \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -derivedDataPath ./build_output \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            EXCLUDED_ARCHS="x86_64"

      - name: Export IPA
        run: |
          mkdir -p Payload
          
          # ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã®.appãƒ•ã‚©ãƒ«ãƒ€ã‚’Payloadã«ã‚³ãƒ”ãƒ¼
          find ./build_output -name "*.app" -type d -exec cp -R {} Payload/ \;
          
          # ã€ãƒãƒƒã‚­ãƒ³ã‚°ã®è‚ğŸ”¥ã€‘
          # Xcodeã«ç„¡è¦–ã•ã‚ŒãŸãƒ€ãƒŸãƒ¼ã®Googleè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€å®Œæˆã—ãŸã‚¢ãƒ—ãƒªã®å†…éƒ¨ï¼ˆãƒãƒ³ãƒ‰ãƒ«ç›´ä¸‹ï¼‰ã«ç›´æ¥å¼·åˆ¶ã‚³ãƒ”ãƒ¼ã™ã‚‹
          cp GoogleService-Info.plist Payload/*.app/
          echo "âœ… Injected Dummy GoogleService-Info.plist into the app bundle!"
          
          echo "Checking Payload size..."
          du -sh Payload/
          
          SIZE_KB=$(du -sk Payload | cut -f1)
          if [ "$SIZE_KB" -lt 1000 ]; then
            echo "Error: Payload is too small ($SIZE_KB KB). The real app was still not built!"
            exit 1
          fi
          
          zip -r MyLLM.ipa Payload

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyLLM-IPA
          path: MyLLM.ipa
